{% load static %}
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë©”ì´í”ŒìŠ¤í† ë¦¬ AI ì±—ë´‡</title>
    <link rel="stylesheet" href="{% static 'css/common.css' %}?v=maple-orange">
    <link rel="stylesheet" href="{% static 'css/main_page.css' %}?v=maple-orange">
    <link rel="stylesheet" href="{% static 'css/chatbot.css' %}?v=maple-orange">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <div class="container">
        <!-- í—¤ë” -->
        <header class="header">
            <div class="header-content">
                <div class="logo">
                    <i class="fas fa-dragon"></i>
                    <span>ë©”ì´í”ŒìŠ¤í† ë¦¬ AI</span>
                </div>
                <button class="nav-toggle" aria-controls="primaryNav" aria-expanded="false" aria-label="ë©”ë‰´ í† ê¸€">
                    <i class="fas fa-bars"></i>
                </button>
                <nav class="nav" id="primaryNav">
                    <a href="{% url 'main_page' %}" class="nav-link">
                        <i class="fas fa-home"></i> í™ˆ
                    </a>
                    <a href="{% url 'chatbot' %}" class="nav-link active">
                        <i class="fas fa-comments"></i> ì±—ë´‡
                    </a>
                    <a href="{% url 'character_info' %}" class="nav-link">
                        <i class="fas fa-user"></i> ìºë¦­í„° ì •ë³´
                    </a>
                </nav>
                <div class="user-actions">
                    <button id="clearHistoryBtn" class="btn-clear-history" onclick="clearHistory()">
                        <i class="fas fa-trash"></i> ëŒ€í™” ì´ˆê¸°í™”
                    </button>
                    <button id="loginBtn" class="btn-login">
                        <i class="fas fa-sign-in-alt"></i> ë¡œê·¸ì¸
                    </button>
                </div>
            </div>
        </header>

        <!-- ìƒë‹¨ ê´‘ê³  ë°°ë„ˆ -->
        <div class="ad-banner" aria-label="ìƒë‹¨ ê´‘ê³  ë°°ë„ˆ">
            <div class="ad-slot ad-slot--horizontal" data-ad-slot="leaderboard">
                ìƒë‹¨ ê´‘ê³  970x90 ì˜ì—­
            </div>
        </div>

        <!-- í˜ì´ì§€ ë ˆì´ì•„ì›ƒ: ì±„íŒ… ë³¸ë¬¸ + ì‚¬ì´ë“œ ê´‘ê³  -->
        <div class="page-grid">
            <main class="chat-main">
                <!-- ì±—ë´‡ ì»¨í…Œì´ë„ˆ -->
                <div class="chatbot-container">
            <div class="chat-header">
                <div class="chat-title">
                    <i class="fas fa-robot"></i>
                    <span>ë©”ì´í”ŒìŠ¤í† ë¦¬ AI ì–´ì‹œìŠ¤í„´íŠ¸</span>
                </div>
                <div class="status-indicator" id="status-indicator">
                    <i class="fas fa-circle"></i>
                    <span id="status-text">ì—°ê²° í™•ì¸ ì¤‘...</span>
                </div>
            </div>
            
            <!-- ì±„íŒ… ì˜ì—­ -->
            <div class="chat-area">
                <div id="chat-box" class="chat-messages">
                    <div class="welcome-message">
                        <div class="message bot">
                            <div class="message-avatar">
                                <i class="fas fa-robot"></i>
                            </div>
                            <div class="message-content">
                                <div class="message-header">
                                    <span class="sender-name">ë©”ì´í”ŒìŠ¤í† ë¦¬ AI</span>
                                    <span class="message-time" id="current-time"></span>
                                </div>
                                <div class="message-text">
                                    ì•ˆë…•í•˜ì„¸ìš”! ë©”ì´í”ŒìŠ¤í† ë¦¬ì— ëŒ€í•œ ì§ˆë¬¸ì´ ìˆìœ¼ì‹œë©´ ì–¸ì œë“  ë¬¼ì–´ë³´ì„¸ìš”. 
                                    ê²Œì„ ì •ë³´, ìºë¦­í„° ì •ë³´, ì•„ì´í…œ ì •ë³´, í€˜ìŠ¤íŠ¸ ë“± ë¬´ì—‡ì´ë“  ë„ì™€ë“œë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                                    <br><br>
                                    <strong>ìƒˆë¡œìš´ ê¸°ëŠ¥:</strong>
                                    <ul>
                                        <li>ğŸ’¬ ëŒ€í™” íˆìŠ¤í† ë¦¬ ìœ ì§€</li>
                                        <li>ğŸ” RAG ê¸°ë°˜ ì •í™•í•œ ì •ë³´ ì œê³µ</li>
                                        <li>ğŸ“š ì†ŒìŠ¤ ë¬¸ì„œ ì°¸ì¡°</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- ì…ë ¥ ì˜ì—­ -->
                <div class="input-container">
                    <div class="suggested-prompts" aria-label="ì¶”ì²œ í”„ë¡¬í”„íŠ¸">
                        <button class="prompt-chip" data-text="ì˜¤ëŠ˜ íŒ¨ì¹˜ë…¸íŠ¸ ìš”ì•½í•´ì¤˜">ì˜¤ëŠ˜ íŒ¨ì¹˜ë…¸íŠ¸ ìš”ì•½</button>
                        <button class="prompt-chip" data-text="ì•„ë¸ 250ë ˆë²¨ ì‚¬ëƒ¥í„° ì¶”ì²œí•´ì¤˜">ì•„ë¸ 250 ì‚¬ëƒ¥í„°</button>
                        <button class="prompt-chip" data-text="ë¬´ìë³¸ ì‹œì‘ ì§ì—… ì¶”ì²œ ì´ìœ ì™€ í•¨ê»˜ ì•Œë ¤ì¤˜">ë¬´ìë³¸ ì§ì—… ì¶”ì²œ</button>
                        <button class="prompt-chip" data-text="ì´ë²ˆ ì£¼ ë³´ìŠ¤ ê³µëµ í•µì‹¬ë§Œ ì •ë¦¬í•´ì¤˜">ì´ë²ˆ ì£¼ ë³´ìŠ¤ ê³µëµ</button>
                    </div>
                    <div class="input-wrapper">
                        <textarea id="user-input" 
                                  placeholder="ë©”ì´í”ŒìŠ¤í† ë¦¬ì— ëŒ€í•´ ì§ˆë¬¸í•´ë³´ì„¸ìš”..." 
                                  rows="1"
                                  onkeydown="handleKeyPress(event)"></textarea>
                        <button id="send-button" onclick="sendMessage()" disabled>
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                    <div class="typing-indicator" id="typing-indicator" style="display: none;">
                        <div class="typing-dots">
                            <span></span>
                            <span></span>
                            <span></span>
                        </div>
                        <span>AIê°€ ì‘ë‹µì„ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤...</span>
                    </div>
                </div>
                </div>
            </main>

            <aside class="sidebar-ads" aria-label="ì‚¬ì´ë“œ ê´‘ê³ ">
                <div class="ad-card">
                    <div class="ad-slot ad-slot--square" data-ad-slot="medium-rectangle">
                        ì‚¬ì´ë“œ ê´‘ê³  300x250
                    </div>
                </div>
                <div class="ad-card">
                    <div class="ad-slot ad-slot--tall" data-ad-slot="skyscraper">
                        ì‚¬ì´ë“œ ê´‘ê³  160x600
                    </div>
                </div>
                <div class="ad-card brand-visual" aria-label="ë¸Œëœë“œ/ë§ˆìŠ¤ì½”íŠ¸ ì´ë¯¸ì§€ ì˜ì—­">
                    ë¸Œëœë“œ ì´ë¯¸ì§€ ì˜ì—­(ì¶”í›„ êµì²´)
                </div>
            </aside>
        </div>
    </div>

    <script>
        let isConnected = false;
        let messageCount = 0;
        let chatHistory = [];
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        window.onload = function() {
            updateCurrentTime();
            setInterval(updateCurrentTime, 1000);
            checkServerStatus();
            setupAutoResize();
            loadChatHistory();
            setupNavToggle();
            setupSuggestedPrompts();
        };
        // ë‚´ë¹„ê²Œì´ì…˜ í† ê¸€
        function setupNavToggle() {
            const navToggle = document.querySelector('.nav-toggle');
            const nav = document.getElementById('primaryNav');
            if (navToggle && nav) {
                navToggle.addEventListener('click', () => {
                    const isOpen = nav.classList.toggle('open');
                    navToggle.setAttribute('aria-expanded', isOpen ? 'true' : 'false');
                });
            }
        }

        // ì¶”ì²œ í”„ë¡¬í”„íŠ¸ í´ë¦­
        function setupSuggestedPrompts() {
            const chips = document.querySelectorAll('.prompt-chip');
            const textarea = document.getElementById('user-input');
            chips.forEach(chip => {
                chip.addEventListener('click', () => {
                    textarea.value = chip.getAttribute('data-text') || chip.textContent.trim();
                    textarea.dispatchEvent(new Event('input'));
                    textarea.focus();
                });
            });
        }

        
        // í˜„ì¬ ì‹œê°„ ì—…ë°ì´íŠ¸
        function updateCurrentTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('ko-KR', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
            document.getElementById('current-time').textContent = timeString;
        }
        
        // í…ìŠ¤íŠ¸ ì˜ì—­ ìë™ í¬ê¸° ì¡°ì •
        function setupAutoResize() {
            const textarea = document.getElementById('user-input');
            textarea.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 120) + 'px';
            });
        }
        
        // ì„œë²„ ìƒíƒœ í™•ì¸
        function checkServerStatus() {
            fetch('{% url "chatbot_health" %}')
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'healthy') {
                        updateStatus('connected', 'ì—°ê²°ë¨');
                        isConnected = true;
                        document.getElementById('send-button').disabled = false;
                    } else {
                        updateStatus('disconnected', 'ì—°ê²° ì•ˆë¨');
                        isConnected = false;
                        document.getElementById('send-button').disabled = true;
                    }
                })
                .catch(error => {
                    updateStatus('disconnected', 'ì—°ê²° ì•ˆë¨');
                    isConnected = false;
                    document.getElementById('send-button').disabled = true;
                });
        }
        
        // ì±„íŒ… íˆìŠ¤í† ë¦¬ ë¡œë“œ
        function loadChatHistory() {
            fetch('{% url "chatbot_history" %}?user_id=anonymous')
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success' && data.history.length > 0) {
                        chatHistory = data.history;
                        displayChatHistory();
                    }
                })
                .catch(error => {
                    console.log('íˆìŠ¤í† ë¦¬ ë¡œë“œ ì‹¤íŒ¨:', error);
                });
        }
        
        // ì±„íŒ… íˆìŠ¤í† ë¦¬ í‘œì‹œ
        function displayChatHistory() {
            const chatBox = document.getElementById("chat-box");
            const welcomeMessage = chatBox.querySelector('.welcome-message');
            
            // í™˜ì˜ ë©”ì‹œì§€ ì œê±°
            if (welcomeMessage) {
                welcomeMessage.remove();
            }
            
            // íˆìŠ¤í† ë¦¬ ë©”ì‹œì§€ë“¤ ì¶”ê°€
            chatHistory.forEach(item => {
                addMessage('user', item.user, 'ì‚¬ìš©ì');
                addMessage('bot', item.assistant, 'ë©”ì´í”ŒìŠ¤í† ë¦¬ AI');
            });
        }
        
        // íˆìŠ¤í† ë¦¬ ì´ˆê¸°í™”
        function clearHistory() {
            if (confirm('ëŒ€í™” íˆìŠ¤í† ë¦¬ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                fetch('{% url "chatbot_clear_history" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        user_id: 'anonymous'
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        // ì±„íŒ… ë°•ìŠ¤ ì´ˆê¸°í™”
                        const chatBox = document.getElementById("chat-box");
                        chatBox.innerHTML = `
                            <div class="welcome-message">
                                <div class="message bot">
                                    <div class="message-avatar">
                                        <i class="fas fa-robot"></i>
                                    </div>
                                    <div class="message-content">
                                        <div class="message-header">
                                            <span class="sender-name">ë©”ì´í”ŒìŠ¤í† ë¦¬ AI</span>
                                            <span class="message-time" id="current-time"></span>
                                        </div>
                                        <div class="message-text">
                                            ëŒ€í™”ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤. ìƒˆë¡œìš´ ì§ˆë¬¸ì„ í•´ì£¼ì„¸ìš”!
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                        chatHistory = [];
                        messageCount = 0;
                    }
                })
                .catch(error => {
                    console.log('íˆìŠ¤í† ë¦¬ ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
                });
            }
        }
        
        // ìƒíƒœ ì—…ë°ì´íŠ¸
        function updateStatus(status, text) {
            const indicator = document.getElementById('status-indicator');
            const statusText = document.getElementById('status-text');
            
            indicator.className = `status-indicator ${status}`;
            statusText.textContent = text;
        }
        
        // í‚¤ë³´ë“œ ì´ë²¤íŠ¸ ì²˜ë¦¬
        function handleKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }
        
        // ë©”ì‹œì§€ ì „ì†¡
        function sendMessage() {
            let userInput = document.getElementById("user-input");
            let chatBox = document.getElementById("chat-box");
            let typingIndicator = document.getElementById("typing-indicator");
            let sendButton = document.getElementById("send-button");
            
            const message = userInput.value.trim();
            if (message === "" || !isConnected) return;
            
            // ì‚¬ìš©ì ë©”ì‹œì§€ ì¶”ê°€
            addMessage('user', message, 'ì‚¬ìš©ì');
            
            // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™” ë° ë²„íŠ¼ ë¹„í™œì„±í™”
            userInput.value = "";
            userInput.style.height = 'auto';
            sendButton.disabled = true;
            
            // íƒ€ì´í•‘ ì¸ë””ì¼€ì´í„° í‘œì‹œ
            typingIndicator.style.display = 'flex';
            
            // Django ì„œë²„ì— ìš”ì²­
            fetch('{% url "chatbot_ask" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    question: message,
                    user_id: 'anonymous'
                })
            })
            .then(response => response.json())
            .then(data => {
                typingIndicator.style.display = 'none';
                sendButton.disabled = false;
                
                if (data.status === 'success') {
                    let responseText = data.response;
                    
                    // RAG ì†ŒìŠ¤ ì •ë³´ ì¶”ê°€
                    if (data.has_rag && data.sources && data.sources.length > 0) {
                        responseText += '\n\n<strong>ì°¸ê³  ì†ŒìŠ¤:</strong>\n';
                        data.sources.forEach((source, index) => {
                            responseText += `${index + 1}. ${source}\n`;
                        });
                    }
                    
                    addMessage('bot', responseText, 'ë©”ì´í”ŒìŠ¤í† ë¦¬ AI');
                } else {
                    addMessage('bot', data.error || 'ì£„ì†¡í•©ë‹ˆë‹¤. ì‘ë‹µì„ ìƒì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'ë©”ì´í”ŒìŠ¤í† ë¦¬ AI', 'error');
                }
            })
            .catch(error => {
                typingIndicator.style.display = 'none';
                sendButton.disabled = false;
                addMessage('bot', 'ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.', 'ë©”ì´í”ŒìŠ¤í† ë¦¬ AI', 'error');
            });
        }
        
        // CSRF í† í° ê°€ì ¸ì˜¤ê¸°
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        
        // ë©”ì‹œì§€ ì¶”ê°€ í•¨ìˆ˜
        function addMessage(type, text, sender, messageType = 'normal') {
            const chatBox = document.getElementById("chat-box");
            const now = new Date();
            const timeString = now.toLocaleTimeString('ko-KR', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
            
            const messageClass = messageType === 'error' ? 'message bot error' : `message ${type}`;
            const iconClass = type === 'user' ? 'fas fa-user' : 'fas fa-robot';
            
            const formatted = formatText(text);
            const copyAction = type === 'bot' ? `<div class="message-actions"><button class="copy-btn" title="ë³µì‚¬"><i class="fas fa-copy"></i></button></div>` : '';
            const messageHtml = `
                <div class="${messageClass}">
                    <div class="message-avatar">
                        <i class="${iconClass}"></i>
                    </div>
                    <div class="message-content">
                        <div class="message-header">
                            <span class="sender-name">${sender}</span>
                            <span class="message-time">${timeString}</span>
                        </div>
                        <div class="message-text">${formatted}</div>
                        ${copyAction}
                    </div>
                </div>
            `;
            
            chatBox.innerHTML += messageHtml;
            chatBox.scrollTop = chatBox.scrollHeight;
            messageCount++;
            // ë³µì‚¬ ë²„íŠ¼ ìœ„ì„
            if (type === 'bot') {
                const lastMsg = chatBox.lastElementChild;
                const btn = lastMsg?.querySelector('.copy-btn');
                const textEl = lastMsg?.querySelector('.message-text');
                if (btn && textEl) {
                    btn.addEventListener('click', () => {
                        copyToClipboard(textEl.innerText);
                    });
                }
            }
        }
        
        // HTML ì´ìŠ¤ì¼€ì´í”„ í•¨ìˆ˜
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // í…ìŠ¤íŠ¸ í¬ë§·íŒ…: ì¤„ë°”ê¿ˆ/URL ë§í¬
        function formatText(text) {
            const escaped = escapeHtml(text);
            const withLinks = escaped.replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank" rel="noopener">$1<\/a>');
            return withLinks.replace(/\n/g, '<br/>');
        }

        // ë³µì‚¬ ê¸°ëŠ¥
        function copyToClipboard(str) {
            navigator.clipboard.writeText(str).then(() => {
                // ê°„ë‹¨í•œ í™•ì¸
                console.log('ë³µì‚¬ ì™„ë£Œ');
            }).catch(() => {
                console.log('ë³µì‚¬ ì‹¤íŒ¨');
            });
        }
        
        // ì…ë ¥ í•„ë“œ ë³€ê²½ ê°ì§€
        document.getElementById('user-input').addEventListener('input', function() {
            const sendButton = document.getElementById('send-button');
            sendButton.disabled = this.value.trim() === '' || !isConnected;
        });
        
        // ì£¼ê¸°ì ìœ¼ë¡œ ì„œë²„ ìƒíƒœ í™•ì¸
        setInterval(checkServerStatus, 30000); // 30ì´ˆë§ˆë‹¤ í™•ì¸
    </script>
</body>
</html>
