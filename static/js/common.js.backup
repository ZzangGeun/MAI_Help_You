/**
 * Maple Story ChatBot - Common JavaScript
 * ê³µí†µ JavaScript ê¸°ëŠ¥ë“¤
 */

// Global configuration
const CONFIG = {
    ANIMATION_DURATION: 300,
    DEBOUNCE_DELAY: 500,
    API_BASE_URL: '/api', // ì¶”í›„ API ì—°ë™ì‹œ ì‚¬ìš©
};

/**
 * Navigation related functions
 */
function setActiveNavItem(pageName) {
    document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.remove('active');
        if (item.textContent.trim() === pageName) {
            item.classList.add('active');
        }
    });
}

/**
 * Search functionality
 */
function initializeSearch() {
    const searchInput = document.querySelector('.search-input');
    const searchBtn = document.querySelector('.search-btn');
    
    if (!searchInput || !searchBtn) return;

    let searchTimeout;

    // Debounced search
    searchInput.addEventListener('input', function(e) {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            performSearch(e.target.value);
        }, CONFIG.DEBOUNCE_DELAY);
    });

    // Search on button click
    searchBtn.addEventListener('click', function() {
        performSearch(searchInput.value);
    });

    // Search on Enter key
    searchInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            performSearch(e.target.value);
        }
    });
}

function performSearch(query) {
    if (!query.trim()) return;
    
    // Check if we're on the home page
    const isHomePage = window.location.pathname === '/' || 
                       window.location.pathname === '' ||
                       document.title.includes('MAI -');
    
    if (isHomePage) {
        // Redirect to chat page with query
        redirectToChatWithQuery(query);
    } else {
        // If already on chat page, just fill the input
        const chatInput = document.getElementById('mainChatInput');
        if (chatInput && window.ChatPage) {
            window.ChatPage.fillInput(query);
            showNotification(`"${query}"ë¥¼ ì±„íŒ…ì°½ì— ì…ë ¥í–ˆìŠµë‹ˆë‹¤.`, 'success');
        } else {
            redirectToChatWithQuery(query);
        }
    }
}

function redirectToChatWithQuery(query) {
    // Save query to sessionStorage for the chat page to pick up
    sessionStorage.setItem('pendingChatQuery', query);
    
    // Show loading
    showLoading('ChatBot í˜ì´ì§€ë¡œ ì´ë™ì¤‘...');
    
    // Redirect after a short delay for better UX
    setTimeout(() => {
        window.location.href = '/chatbot/';
    }, 500);
}

/**
 * Notification system
 */
function showNotification(message, type = 'info', duration = 3000) {
    // Remove existing notifications
    const existing = document.querySelector('.notification');
    if (existing) {
        existing.remove();
    }

    const notification = document.createElement('div');
    notification.className = `notification notification-${type}`;
    notification.textContent = message;
    
    // Styles
    Object.assign(notification.style, {
        position: 'fixed',
        top: '20px',
        right: '20px',
        padding: '12px 20px',
        borderRadius: '8px',
        color: 'white',
        fontFamily: 'Pretendard, sans-serif',
        fontSize: '14px',
        fontWeight: '500',
        zIndex: '10000',
        boxShadow: '0 4px 15px rgba(0,0,0,0.2)',
        transition: 'all 0.3s ease',
        transform: 'translateX(100%)',
        opacity: '0'
    });

    // Type-specific colors
    const colors = {
        info: '#3498db',
        success: '#2ecc71',
        warning: '#f39c12',
        error: '#e74c3c'
    };
    notification.style.background = colors[type] || colors.info;

    document.body.appendChild(notification);

    // Animate in
    setTimeout(() => {
        notification.style.transform = 'translateX(0)';
        notification.style.opacity = '1';
    }, 10);

    // Animate out
    setTimeout(() => {
        notification.style.transform = 'translateX(100%)';
        notification.style.opacity = '0';
        setTimeout(() => {
            if (notification.parentNode) {
                notification.remove();
            }
        }, 300);
    }, duration);
}

/**
 * Smooth scrolling utility
 */
function smoothScrollTo(element, offset = 0) {
    if (typeof element === 'string') {
        element = document.querySelector(element);
    }
    
    if (!element) return;

    const elementPosition = element.offsetTop - offset;
    const startPosition = window.pageYOffset;
    const distance = elementPosition - startPosition;
    const duration = 800;
    let start = null;

    function animation(currentTime) {
        if (start === null) start = currentTime;
        const timeElapsed = currentTime - start;
        const run = ease(timeElapsed, startPosition, distance, duration);
        window.scrollTo(0, run);
        if (timeElapsed < duration) requestAnimationFrame(animation);
    }

    function ease(t, b, c, d) {
        t /= d / 2;
        if (t < 1) return c / 2 * t * t + b;
        t--;
        return -c / 2 * (t * (t - 2) - 1) + b;
    }

    requestAnimationFrame(animation);
}

/**
 * Theme utilities
 */
function toggleTheme() {
    const body = document.body;
    const isDark = body.classList.contains('dark-theme');
    
    if (isDark) {
        body.classList.remove('dark-theme');
        localStorage.setItem('theme', 'light');
    } else {
        body.classList.add('dark-theme');
        localStorage.setItem('theme', 'dark');
    }
}

function initializeTheme() {
    const savedTheme = localStorage.getItem('theme');
    if (savedTheme === 'dark') {
        document.body.classList.add('dark-theme');
    }
}

/**
 * Loading utilities
 */
function showLoading(message = 'ë¡œë”©ì¤‘...') {
    const existing = document.querySelector('.loading-overlay');
    if (existing) return;

    const overlay = document.createElement('div');
    overlay.className = 'loading-overlay';
    overlay.innerHTML = `
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <div class="loading-text">${message}</div>
        </div>
    `;

    // Styles
    Object.assign(overlay.style, {
        position: 'fixed',
        top: '0',
        left: '0',
        width: '100%',
        height: '100%',
        background: 'rgba(0,0,0,0.5)',
        display: 'flex',
        alignItems: 'center',
        justifyContent: 'center',
        zIndex: '10001',
        backdropFilter: 'blur(4px)'
    });

    const content = overlay.querySelector('.loading-content');
    Object.assign(content.style, {
        background: 'white',
        padding: '30px',
        borderRadius: '15px',
        textAlign: 'center',
        boxShadow: '0 10px 30px rgba(0,0,0,0.3)'
    });

    const spinner = overlay.querySelector('.loading-spinner');
    Object.assign(spinner.style, {
        width: '40px',
        height: '40px',
        border: '4px solid #f3f3f3',
        borderTop: '4px solid #e89611',
        borderRadius: '50%',
        margin: '0 auto 15px',
        animation: 'spin 1s linear infinite'
    });

    const text = overlay.querySelector('.loading-text');
    Object.assign(text.style, {
        fontFamily: 'Pretendard, sans-serif',
        fontSize: '16px',
        color: '#333'
    });

    // Add spinner animation
    const style = document.createElement('style');
    style.textContent = `
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    `;
    document.head.appendChild(style);

    document.body.appendChild(overlay);
}

function hideLoading() {
    const overlay = document.querySelector('.loading-overlay');
    if (overlay) {
        overlay.style.opacity = '0';
        setTimeout(() => {
            if (overlay.parentNode) {
                overlay.remove();
            }
        }, 300);
    }
}

/**
 * Responsive utilities
 */
function isMobile() {
    return window.innerWidth <= 768;
}

function isTablet() {
    return window.innerWidth > 768 && window.innerWidth <= 1024;
}

function isDesktop() {
    return window.innerWidth > 1024;
}

/**
 * Local Storage utilities
 */
function saveToStorage(key, value) {
    try {
        localStorage.setItem(key, JSON.stringify(value));
        return true;
    } catch (e) {
        console.error('Failed to save to localStorage:', e);
        return false;
    }
}

function loadFromStorage(key, defaultValue = null) {
    try {
        const item = localStorage.getItem(key);
        return item ? JSON.parse(item) : defaultValue;
    } catch (e) {
        console.error('Failed to load from localStorage:', e);
        return defaultValue;
    }
}

/**
 * Login/Logout functionality
 */
function performLogin() {
    const username = document.getElementById('usernameInput').value.trim();
    const password = document.getElementById('passwordInput').value.trim();
    
    if (!username || !password) {
        showNotification('ì•„ì´ë””ì™€ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'warning');
        return;
    }
    
    // Simple login simulation - in real app, this would be an API call
    if (username.length >= 2) {
        showLoading('ë¡œê·¸ì¸ ì¤‘...');
        
        setTimeout(() => {
            // Save login state
            const loginData = {
                isLoggedIn: true,
                username: username,
                loginTime: new Date().toISOString()
            };
            saveToStorage('loginState', loginData);
            
            // Update UI
            updateLoginUI(loginData);
            hideLoading();
            showNotification(`${username}ë‹˜, í™˜ì˜í•©ë‹ˆë‹¤!`, 'success');
        }, 1000);
    } else {
        showNotification('ì˜¬ë°”ë¥¸ ì•„ì´ë””ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
    }
}

async function performLogout() {
    showLoading('ë¡œê·¸ì•„ì›ƒ ì¤‘...');
    
    try {
        // ì‹¤ì œ Django API í˜¸ì¶œ
        const response = await fetch('/accounts/api/logout/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        const data = await response.json();
        
        // ì„±ê³µ ì—¬ë¶€ì™€ ê´€ê³„ì—†ì´ ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ í´ë¦¬ì–´
        localStorage.removeItem('loginState');
        
        // Update UI
        updateLoginUI(null);
        hideLoading();
        
        if (response.ok && data.status === 'success') {
            showNotification(data.message || 'ë¡œê·¸ì•„ì›ƒë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
        } else {
            showNotification('ë¡œê·¸ì•„ì›ƒë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
        }
        
        // ê³„ì • íŒì—…ì´ ì—´ë ¤ìˆìœ¼ë©´ ë‹«ê¸°
        hideAccountPopup();
        
    } catch (error) {
        console.error('Logout error:', error);
        // ì˜¤ë¥˜ê°€ ë°œìƒí•´ë„ ë¡œì»¬ ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬
        localStorage.removeItem('loginState');
        updateLoginUI(null);
        hideLoading();
        showNotification('ë¡œê·¸ì•„ì›ƒë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
    }
}

function updateLoginUI(loginData) {
    // Navigation elements
    const navLoginSection = document.getElementById('navLoginSection');
    const navUserProfile = document.getElementById('navUserProfile');
    const navLoggedInUser = document.getElementById('navLoggedInUser');
    
    // Chat page specific elements
    const chatHistoryContainer = document.getElementById('chatHistoryContainer');
    const equipmentWindow = document.getElementById('equipmentWindow');
    const equipmentCharacterName = document.getElementById('equipmentCharacterName');
    
    if (loginData && loginData.isLoggedIn) {
        // User is logged in
        if (navLoginSection) navLoginSection.classList.add('hidden');
        
        // Show navigation user profile
        if (navUserProfile) {
            navUserProfile.classList.remove('hidden');
            if (navLoggedInUser) navLoggedInUser.textContent = loginData.username;
        }
        
        // Show chat history on chat page
        if (chatHistoryContainer) {
            chatHistoryContainer.classList.remove('hidden');
        }

        // Show equipment window on home page
        if (equipmentWindow) {
            equipmentWindow.classList.remove('hidden');
            if (equipmentCharacterName) {
                equipmentCharacterName.textContent = loginData.username;
            }
        }
        
    } else {
        // User is not logged in
        if (navLoginSection) navLoginSection.classList.remove('hidden');
        
        // Hide navigation user profile
        if (navUserProfile) navUserProfile.classList.add('hidden');
        
        // Hide chat history
        if (chatHistoryContainer) {
            chatHistoryContainer.classList.add('hidden');
        }

        // Hide equipment window
        if (equipmentWindow) {
            equipmentWindow.classList.add('hidden');
        }
    }
}


function initializeLoginState() {
    const loginData = loadFromStorage('loginState');
    updateLoginUI(loginData);
}

/**
 * Show signup popup
 */
function showSignupPopup() {
    const overlay = document.getElementById('signupPopupOverlay');
    
    if (overlay) {
        overlay.classList.remove('hidden');
        overlay.style.display = 'flex';
        document.body.style.overflow = 'hidden';
        
        // Focus on user ID input
        setTimeout(() => {
            const userIdInput = document.getElementById('signupUserIdInput');
            if (userIdInput) userIdInput.focus();
        }, 100);
    }
}

/**
 * Hide signup popup
 */
function hideSignupPopup() {
    const overlay = document.getElementById('signupPopupOverlay');
    if (overlay) {
        overlay.classList.add('hidden');
        overlay.style.display = 'none';
        document.body.style.overflow = 'auto';
        
        // Clear form inputs
        const userIdInput = document.getElementById('signupUserIdInput');
        const passwordInput = document.getElementById('signupPasswordInput');
        const confirmInput = document.getElementById('signupPasswordConfirmInput');
        const mapleNicknameInput = document.getElementById('signupMapleNicknameInput');
        const apiKeyInput = document.getElementById('signupNexonApiKeyInput');
        
        if (userIdInput) userIdInput.value = '';
        if (passwordInput) passwordInput.value = '';
        if (confirmInput) confirmInput.value = '';
        if (mapleNicknameInput) mapleNicknameInput.value = '';
        if (apiKeyInput) apiKeyInput.value = '';
    }
}

/**
 * Perform signup
 */
async function performSignup() {
    const userIdInput = document.getElementById('signupUserIdInput');
    const passwordInput = document.getElementById('signupPasswordInput');
    const confirmInput = document.getElementById('signupPasswordConfirmInput');
    const mapleNicknameInput = document.getElementById('signupMapleNicknameInput');
    const apiKeyInput = document.getElementById('signupNexonApiKeyInput');
    
    const user_id = userIdInput ? userIdInput.value.trim() : '';
    const password = passwordInput ? passwordInput.value.trim() : '';
    const confirm_password = confirmInput ? confirmInput.value.trim() : '';
    const maple_nickname = mapleNicknameInput ? mapleNicknameInput.value.trim() : '';
    const nexon_api_key = apiKeyInput ? apiKeyInput.value.trim() : '';
    
    // ìœ íš¨ì„± ê²€ì‚¬
    if (!user_id || !password || !confirm_password || !maple_nickname) {
        showNotification('í•„ìˆ˜ í•­ëª©ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'warning');
        return;
    }
    
    if (!/^[a-zA-Z0-9_]{4,20}$/.test(user_id)) {
        showNotification('ì•„ì´ë””ëŠ” 4~20ìì˜ ì˜ë¬¸ì, ìˆ«ì, ë°‘ì¤„(_)ë§Œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.', 'warning');
        return;
    }
    
    if (password.length < 8) {
        showNotification('ë¹„ë°€ë²ˆí˜¸ëŠ” ìµœì†Œ 8ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.', 'warning');
        return;
    }
    
    if (password !== confirm_password) {
        showNotification('ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.', 'warning');
        return;
    }
    
    if (maple_nickname.length > 12) {
        showNotification('ë©”ì´í”Œ ë‹‰ë„¤ì„ì€ ìµœëŒ€ 12ìê¹Œì§€ ì…ë ¥ ê°€ëŠ¥í•©ë‹ˆë‹¤.', 'warning');
        return;
    }
    
    showLoading('íšŒì›ê°€ì… ì²˜ë¦¬ ì¤‘...');
    
    try {
        // ì‹¤ì œ Django API í˜¸ì¶œ
        const response = await fetch('/accounts/api/signup/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                user_id: user_id,
                password: password,
                confirm_password: confirm_password,
                maple_nickname: maple_nickname,
                nexon_api_key: nexon_api_key
            })
        });
        
        const data = await response.json();
        
        if (response.ok && data.status === 'success') {
            // íšŒì›ê°€ì… ì„±ê³µ
            hideSignupPopup();
            hideLoading();
            showNotification(data.message || 'íšŒì›ê°€ì…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.', 'success');
            
            // ë¡œê·¸ì¸ íŒì—… ì—´ê¸°
            setTimeout(() => {
                showLoginPopup();
                // ê°€ì…í•œ ì•„ì´ë””ë¥¼ ë¡œê·¸ì¸ í¼ì— ìë™ ì…ë ¥
                const loginUsernameInput = document.getElementById('popupUsernameInput');
                if (loginUsernameInput) {
                    loginUsernameInput.value = user_id;
                    const loginPasswordInput = document.getElementById('popupPasswordInput');
                    if (loginPasswordInput) loginPasswordInput.focus();
                }
            }, 500);
        } else {
            // íšŒì›ê°€ì… ì‹¤íŒ¨
            hideLoading();
            showNotification(data.error || 'íšŒì›ê°€ì…ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
        }
    } catch (error) {
        console.error('Signup error:', error);
        hideLoading();
        showNotification('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
    }
}

/**
 * Show login popup
 */
function showLoginPopup() {
    console.log('showLoginPopup called'); // Debug log
    const overlay = document.getElementById('loginPopupOverlay');
    console.log('overlay element:', overlay); // Debug log
    
    if (overlay) {
        console.log('Removing hidden class'); // Debug log
        overlay.classList.remove('hidden');
        overlay.style.display = 'flex'; // Force display
        document.body.style.overflow = 'hidden';
        
        // Focus on username input
        setTimeout(() => {
            const usernameInput = document.getElementById('popupUsernameInput');
            if (usernameInput) usernameInput.focus();
        }, 100);
    } else {
        console.log('Login popup overlay not found!'); // Debug log
        // Try to find all elements with loginPopup in their ID
        const allElements = document.querySelectorAll('[id*="loginPopup"]');
        console.log('Found elements:', allElements);
    }
}

/**
 * Hide login popup
 */
function hideLoginPopup() {
    const overlay = document.getElementById('loginPopupOverlay');
    if (overlay) {
        overlay.classList.add('hidden');
        overlay.style.display = 'none'; // Force hide
        document.body.style.overflow = 'auto';
        
        // Clear form inputs
        const usernameInput = document.getElementById('popupUsernameInput');
        const passwordInput = document.getElementById('popupPasswordInput');
        if (usernameInput) usernameInput.value = '';
        if (passwordInput) passwordInput.value = '';
    }
}

/**
 * Popup login functionality
 */
async function performPopupLogin() {
    const usernameInput = document.getElementById('popupUsernameInput');
    const passwordInput = document.getElementById('popupPasswordInput');
    
    const user_id = usernameInput ? usernameInput.value.trim() : '';
    const password = passwordInput ? passwordInput.value.trim() : '';
    
    if (!user_id || !password) {
        showNotification('ì•„ì´ë””ì™€ ë¹„ë°€ë²ˆí˜¸ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'warning');
        return;
    }
    
    showLoading('ë¡œê·¸ì¸ ì¤‘...');
    
    try {
        // ì‹¤ì œ Django API í˜¸ì¶œ
        const response = await fetch('/accounts/api/login/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                user_id: user_id,
                password: password
            })
        });
        
        const data = await response.json();
        
        if (response.ok && data.status === 'success') {
            // ë¡œê·¸ì¸ ì„±ê³µ
            const loginData = {
                isLoggedIn: true,
                username: data.user.user_id,
                email: data.user.email,
                maple_nickname: data.user.maple_nickname,
                loginTime: new Date().toISOString()
            };
            saveToStorage('loginState', loginData);
            
            // Update UI and hide popup
            updateLoginUI(loginData);
            hideLoginPopup();
            hideLoading();
            showNotification(data.message || `${user_id}ë‹˜, í™˜ì˜í•©ë‹ˆë‹¤!`, 'success');
        } else {
            // ë¡œê·¸ì¸ ì‹¤íŒ¨
            hideLoading();
            showNotification(data.error || 'ë¡œê·¸ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
        }
    } catch (error) {
        console.error('Login error:', error);
        hideLoading();
        showNotification('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
    }
}

/**
 * Show account profile popup
 */
function showAccountPopup() {
    const loginData = loadFromStorage('loginState');
    if (!loginData || !loginData.isLoggedIn) {
        showNotification('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.', 'warning');
        return;
    }
    
    const overlay = document.getElementById('accountPopupOverlay');
    const nameElement = document.getElementById('accountName');
    const lastLoginElement = document.getElementById('accountLastLogin');
    
    if (overlay) {
        // Update account info
        if (nameElement) nameElement.textContent = loginData.username;
        if (lastLoginElement) {
            const loginTime = new Date(loginData.loginTime);
            const timeDiff = new Date() - loginTime;
            const minutes = Math.floor(timeDiff / (1000 * 60));
            if (minutes < 1) {
                lastLoginElement.textContent = 'ë°©ê¸ˆ ì „';
            } else if (minutes < 60) {
                lastLoginElement.textContent = `${minutes}ë¶„ ì „`;
            } else {
                const hours = Math.floor(minutes / 60);
                lastLoginElement.textContent = `${hours}ì‹œê°„ ì „`;
            }
        }
        
        overlay.classList.remove('hidden');
        document.body.style.overflow = 'hidden';
    }
}

/**
 * Hide account profile popup
 */
function hideAccountPopup() {
    const overlay = document.getElementById('accountPopupOverlay');
    if (overlay) {
        overlay.classList.add('hidden');
        document.body.style.overflow = 'auto';
    }
}

/**
 * Show profile popup
 */
function showProfilePopup() {
    const loginData = loadFromStorage('loginState');
    if (!loginData || !loginData.isLoggedIn) {
        showNotification('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.', 'warning');
        return;
    }
    
    const overlay = document.getElementById('profilePopupOverlay');
    const nameElement = document.getElementById('profilePopupName');
    const loginTimeElement = document.getElementById('profileLoginTime');
    
    if (overlay) {
        // Update profile info
        if (nameElement) nameElement.textContent = loginData.username;
        if (loginTimeElement) {
            const loginTime = new Date(loginData.loginTime);
            const timeDiff = new Date() - loginTime;
            const minutes = Math.floor(timeDiff / (1000 * 60));
            if (minutes < 1) {
                loginTimeElement.textContent = 'ë°©ê¸ˆ ì „';
            } else if (minutes < 60) {
                loginTimeElement.textContent = `${minutes}ë¶„ ì „`;
            } else {
                const hours = Math.floor(minutes / 60);
                loginTimeElement.textContent = `${hours}ì‹œê°„ ì „`;
            }
        }
        
        overlay.classList.remove('hidden');
        document.body.style.overflow = 'hidden';
    }
}

/**
 * Hide profile popup
 */
function hideProfilePopup() {
    const overlay = document.getElementById('profilePopupOverlay');
    if (overlay) {
        overlay.classList.add('hidden');
        document.body.style.overflow = 'auto';
    }
}

/**
 * Character search functionality
 */
async function searchCharacter(characterName) {
    const searchInput = document.getElementById('characterSearchInput');
    
    // Use provided name or get from input
    const name = characterName || (searchInput ? searchInput.value.trim() : '');
    
    if (!name) {
        showNotification('ìºë¦­í„° ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'warning');
        return;
    }
    
    // Disable search button
    const searchBtn = document.querySelector('.character-search-btn');
    if (searchBtn) {
        searchBtn.disabled = true;
        searchBtn.innerHTML = '<span>ê²€ìƒ‰ì¤‘...</span>';
    }
    
    showLoading(`${name} ìºë¦­í„° ê²€ìƒ‰ ì¤‘...`);
    
    const characterData = await fetchCharacterData(name);
    
    // Add to recent searches only if data is successfully fetched
    if (characterData) {
        addToRecentSearches(name);
        showNotification(`${name} ìºë¦­í„° ì •ë³´ë¥¼ ì°¾ì•˜ìŠµë‹ˆë‹¤!`, 'success');
    } else {
        showNotification(`${name} ìºë¦­í„° ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`, 'error');
    }
    
    // Enable search button
    if (searchBtn) {
        searchBtn.disabled = false;
        searchBtn.innerHTML = '<span>ê²€ìƒ‰</span>';
    }
    
    hideLoading();
    
    // Clear input
    if (searchInput && !characterName) {
        searchInput.value = '';
    }
}

/**
 * Search and display character info in right sidebar
 */
async function searchAndDisplayCharacter(characterName) {
    const searchInput = document.getElementById('characterSearchInput');
    
    // Use provided name or get from input
    const name = characterName || (searchInput ? searchInput.value.trim() : '');
    
    if (!name) {
        showNotification('ìºë¦­í„° ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'warning');
        return;
    }
    
    // Disable search button
    const searchBtn = document.querySelector('.character-search-btn');
    if (searchBtn) {
        searchBtn.disabled = true;
        searchBtn.innerHTML = '<span>ê²€ìƒ‰ì¤‘...</span>';
    }
    
    showLoading(`${name} ìºë¦­í„° ê²€ìƒ‰ ì¤‘...`);
    
    const characterData = await fetchCharacterData(name);
    
    // Add to recent searches only if data is successfully fetched
    if (characterData) {
        addToRecentSearches(name);
        displayCharacterInfo(characterData);
        showNotification(`${name} ìºë¦­í„° ì •ë³´ë¥¼ ì°¾ì•˜ìŠµë‹ˆë‹¤!`, 'success');
    } else {
        showNotification(`${name} ìºë¦­í„° ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`, 'error');
    }
    
    // Enable search button
    if (searchBtn) {
        searchBtn.disabled = false;
        searchBtn.innerHTML = '<span>ê²€ìƒ‰</span>';
    }
    
    hideLoading();
    
    // Clear input
    if (searchInput && !characterName) {
        searchInput.value = '';
    }
}

/**
 * Search character from recent searches (fills input and searches)
 */
function searchFromRecent(characterName) {
    const searchInput = document.getElementById('characterSearchInput');
    
    // Fill the search input with the character name
    if (searchInput) {
        searchInput.value = characterName;
        
        // Add visual focus effect
        searchInput.focus();
        setTimeout(() => {
            searchInput.blur();
        }, 200);
    }
    
    // Execute the search
    searchAndDisplayCharacter(characterName);
}

/**
 * Generate mock character data
 */
async function fetchCharacterData(name) {
    try {
        const response = await fetch(`${CONFIG.API_BASE_URL}/character_info/search/?character_name=${encodeURIComponent(name)}`);
        const data = await response.json();
        if (data.success) {
            return data.data;
        } else {
            showNotification(`ìºë¦­í„° ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ${data.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}`, 'error');
            return null;
        }
    } catch (error) {
        console.error('Error fetching character data:', error);
        showNotification('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ë¡œ ìºë¦­í„° ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
        return null;
    }
}

/**
 * Display character info in the right sidebar
 */
function displayCharacterInfo(data) {
    const infoDisplay = document.getElementById('characterInfoDisplay');
    if (!infoDisplay) return;
    
    // Update character info
    const nameElement = document.getElementById('displayCharacterName');
    const serverElement = document.getElementById('displayServerName');
    const levelElement = document.getElementById('displayCharacterLevel');
    const jobElement = document.getElementById('displayCharacterJob');
    const fameElement = document.getElementById('displayCharacterFame');
    const powerElement = document.getElementById('displayCharacterPower');
    const unionElement = document.getElementById('displayUnionLevel');
    
    if (nameElement) nameElement.textContent = data.character_name;
    if (serverElement) serverElement.textContent = data.world_name;
    if (levelElement) levelElement.textContent = data.character_level;
    if (jobElement) jobElement.textContent = data.character_class;
    if (fameElement) fameElement.textContent = data.character_popularity.toLocaleString();
    if (powerElement) powerElement.textContent = data.combat_power.toLocaleString();
    if (unionElement) unionElement.textContent = data.union_level.toLocaleString();
    
    // Show the character info display
    infoDisplay.classList.remove('hidden');
}

/**
 * Search character from recent searches (fills input and searches)
 */
function searchFromRecent(characterName) {
    const searchInput = document.getElementById('characterSearchInput');
    if (searchInput) {
        searchInput.value = characterName;
    }
    searchAndDisplayCharacter(characterName);
}

function addToRecentSearches(characterName) {
    let recentSearches = loadFromStorage('recentCharacterSearches', []);
    
    // Remove if already exists
    recentSearches = recentSearches.filter(name => name !== characterName);
    
    // Add to beginning
    recentSearches.unshift(characterName);
    
    // Keep only last 5 searches
    recentSearches = recentSearches.slice(0, 5);
    
    // Save to storage
    saveToStorage('recentCharacterSearches', recentSearches);
    
    // Update UI
    updateRecentSearchesUI();
}

function updateRecentSearchesUI() {
    const recentList = document.getElementById('recentSearchList');
    if (!recentList) return;
    
    const recentSearches = loadFromStorage('recentCharacterSearches', []);
    
    recentList.innerHTML = '';
    recentSearches.forEach(name => {
        const item = document.createElement('span');
        item.className = 'search-recent-item';
        item.textContent = name;
        item.onclick = () => searchFromRecent(name);
        recentList.appendChild(item);
    });
}

/**
 * Initialize common functionality
 */
function initializeCommon() {
    initializeSearch();
    initializeTheme();
    initializeLoginState();
    updateRecentSearchesUI();
    
    // Add click handlers for common elements
    document.addEventListener('click', function(e) {
        // Handle smooth scroll links
        if (e.target.matches('a[href^="#"]')) {
            e.preventDefault();
            const target = document.querySelector(e.target.getAttribute('href'));
            if (target) {
                smoothScrollTo(target, 100);
            }
        }
    });

    // Handle responsive menu toggle (for mobile)
    const navToggle = document.querySelector('.nav-toggle');
    const navContent = document.querySelector('.nav-content');
    
    if (navToggle && navContent) {
        navToggle.addEventListener('click', function() {
            navContent.classList.toggle('nav-open');
        });
    }

    // Close mobile menu when clicking outside
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.navigation') && navContent) {
            navContent.classList.remove('nav-open');
        }
    });
    
    // --- Popup Event Listeners ---

    // Open popups
    document.querySelector('.nav-login-btn')?.addEventListener('click', () => {
        showLoginPopup();
    });
    document.querySelector('.nav-profile-btn')?.addEventListener('click', () => {
        showAccountPopup();
    });
    document.querySelector('.nav-logout-btn')?.addEventListener('click', () => {
        performLogout();
    });

    // Theme toggle
    document.getElementById('themeToggleBtn')?.addEventListener('click', toggleTheme);

    // Close popups with close buttons
    document.querySelector('.login-popup-close')?.addEventListener('click', hideLoginPopup);
    document.querySelector('.signup-popup-close')?.addEventListener('click', hideSignupPopup);
    document.querySelector('.account-popup-close')?.addEventListener('click', hideAccountPopup);
    document.querySelector('.profile-popup-close')?.addEventListener('click', hideProfilePopup);

    // Popup actions
    document.querySelector('.login-popup-btn')?.addEventListener('click', performPopupLogin);
    document.querySelector('.signup-popup-btn')?.addEventListener('click', performSignup);
    
    // íšŒì›ê°€ì… íŒì—…ì—ì„œ ë¡œê·¸ì¸ íŒì—…ìœ¼ë¡œ ì´ë™
    document.querySelector('.signup-to-login-link')?.addEventListener('click', function(e) {
        e.preventDefault();
        hideSignupPopup();
        showLoginPopup();
    });
    
    // Enter key support for login popup
    const popupUsernameInput = document.getElementById('popupUsernameInput');
    const popupPasswordInput = document.getElementById('popupPasswordInput');
    
    if (popupUsernameInput) {
        popupUsernameInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                if (popupPasswordInput) {
                    popupPasswordInput.focus();
                }
            }
        });
    }
    
    if (popupPasswordInput) {
        popupPasswordInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                performPopupLogin();
            }
        });
    }
    
    // ë¡œê·¸ì¸ íŒì—…ì—ì„œ íšŒì›ê°€ì… ë§í¬ í´ë¦­ ì‹œ íšŒì›ê°€ì… íŒì—…ìœ¼ë¡œ ì´ë™
    document.getElementById('toSignupLink')?.addEventListener('click', function(e) {
        e.preventDefault();
        console.log('íšŒì›ê°€ì… ë§í¬ í´ë¦­ë¨');
        hideLoginPopup();
        showSignupPopup();
    });
    
    // ë¹„ë°€ë²ˆí˜¸ ì°¾ê¸° ë§í¬
    document.getElementById('forgotPasswordLink')?.addEventListener('click', function(e) {
        e.preventDefault();
        showNotification('ë¹„ë°€ë²ˆí˜¸ ì°¾ê¸° ê¸°ëŠ¥ì€ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.', 'info');
    });
    
    // Account popup buttons
    document.querySelector('#myInfoBtn')?.addEventListener('click', () => {
        const loginData = loadFromStorage('loginState');
        if (loginData && loginData.isLoggedIn) {
            hideAccountPopup();
            // Assuming the main character name is the username for this simulation
            searchAndDisplayCharacter(loginData.username);
            showNotification(`${loginData.username}ë‹˜ì˜ ìºë¦­í„° ì •ë³´ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤.`, 'info');
        }
    });
    document.querySelector('#accountLogoutBtn')?.addEventListener('click', performLogout);
    document.querySelector('.profile-popup-actions .profile-action-btn')?.addEventListener('click', performLogout);

    // --- Global Event Listeners for Popups ---

    // ESC key to close all popups
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            hideLoginPopup();
            hideSignupPopup();
            hideAccountPopup();
            hideProfilePopup();
        }
    });

    // Click outside to close popups
    document.addEventListener('click', function(e) {
        const loginPopupOverlay = document.getElementById('loginPopupOverlay');
        if (loginPopupOverlay && !loginPopupOverlay.classList.contains('hidden')) {
            const loginModal = document.getElementById('loginPopupModal');
            if (loginModal && !loginModal.contains(e.target) && !e.target.closest('.nav-login-btn')) {
                hideLoginPopup();
            }
        }
        
        const signupPopupOverlay = document.getElementById('signupPopupOverlay');
        if (signupPopupOverlay && !signupPopupOverlay.classList.contains('hidden')) {
            const signupModal = document.getElementById('signupPopupModal');
            if (signupModal && !signupModal.contains(e.target)) {
                hideSignupPopup();
            }
        }

        const accountPopupOverlay = document.getElementById('accountPopupOverlay');
        if (accountPopupOverlay && !accountPopupOverlay.classList.contains('hidden')) {
            const accountModal = document.getElementById('accountPopupModal');
            if (accountModal && !accountModal.contains(e.target) && !e.target.closest('.nav-profile-btn')) {
                hideAccountPopup();
            }
        }

        const profilePopupOverlay = document.getElementById('profilePopupOverlay');
        if (profilePopupOverlay && !profilePopupOverlay.classList.contains('hidden')) {
            const profileModal = document.getElementById('profilePopupModal');
            if (profileModal && !profileModal.contains(e.target) && !e.target.closest('.nav-profile-btn')) {
                hideProfilePopup();
            }
        }
    });
}

/**
 * Page transition effects
 */
function fadeIn(element, duration = 500) {
    element.style.opacity = '0';
    element.style.transition = `opacity ${duration}ms ease`;
    
    setTimeout(() => {
        element.style.opacity = '1';
    }, 10);
}

function fadeOut(element, duration = 500) {
    element.style.transition = `opacity ${duration}ms ease`;
    element.style.opacity = '0';
    
    return new Promise(resolve => {
        setTimeout(resolve, duration);
    });
}

// Initialize when DOM is loaded
document.addEventListener('DOMContentLoaded', initializeCommon);

// Export functions for use in other scripts
window.MapleStoryChatBot = {
    setActiveNavItem,
    showNotification,
    smoothScrollTo,
    toggleTheme,
    showLoading,
    hideLoading,
    isMobile,
    isTablet,
    isDesktop,
    saveToStorage,
    loadFromStorage,
    fadeIn,
    fadeOut,
    performSearch,
    redirectToChatWithQuery,
    performLogin,
    performLogout,
    searchCharacter,
    updateLoginUI,
    initializeLoginState,
    showProfilePopup,
    hideProfilePopup
};

// Make functions globally available
window.performLogin = performLogin;
window.performLogout = performLogout;
window.searchCharacter = searchCharacter;
window.searchAndDisplayCharacter = searchAndDisplayCharacter;
window.searchFromRecent = searchFromRecent;

/**
 * Main search functionality for home page
 */
function performMainSearch() {
    const mainSearchInput = document.getElementById('mainSearchInput');
    if (!mainSearchInput) return;
    
    const query = mainSearchInput.value.trim();
    if (!query) {
        showNotification('ì§ˆë¬¸ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'warning');
        return;
    }
    
    // Clear input
    mainSearchInput.value = '';
    
    // Redirect to chat with query
    redirectToChatWithQuery(query);
}

// Add Enter key support for main search
document.addEventListener('DOMContentLoaded', function() {
    const mainSearchInput = document.getElementById('mainSearchInput');
    if (mainSearchInput) {
        mainSearchInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                performMainSearch();
            }
        });
    }
});

window.performMainSearch = performMainSearch;

/**
 * Carousel functionality for events and cash items
 */
const carouselData = {
    events: [
        { icon: 'ğŸ®', title: 'ìœˆí„° ìŠ¤í˜ì…œ ì´ë²¤íŠ¸', description: '12ì›” í•œì • íŠ¹ë³„ ì´ë²¤íŠ¸ê°€ ì§„í–‰ì¤‘ì…ë‹ˆë‹¤', date: 'ğŸ“… 2024.12.01 ~ 2024.12.31' },
        { icon: 'ğŸ', title: 'ì—°ë§ ì„ ë¬¼ ì´ë²¤íŠ¸', description: 'ë§¤ì¼ ì ‘ì†í•˜ê³  íŠ¹ë³„í•œ ì„ ë¬¼ì„ ë°›ì•„ë³´ì„¸ìš”', date: 'ğŸ“… 2024.12.15 ~ 2025.01.15' },
        { icon: 'â­', title: 'ì‹ ë…„ í–‰ìš´ ì´ë²¤íŠ¸', description: 'ìƒˆí•´ë¥¼ ë§ì´í•˜ì—¬ í–‰ìš´ì˜ ë³´ìƒì´ ê¸°ë‹¤ë¦½ë‹ˆë‹¤', date: 'ğŸ“… 2025.01.01 ~ 2025.01.31' }
    ],
    cashItems: [
        { image: 'ğŸ­', title: 'ì‹ ë…„ í•œì • ì½”ìŠ¤íŠ¬', subtitle: '50% í• ì¸ ì§„í–‰ì¤‘', price: '2,400 ìºì‹œ' },
        { image: 'ğŸ’¼', title: 'í”„ë¦¬ë¯¸ì—„ íŒ¨í‚¤ì§€', subtitle: 'íŠ¹ë³„ í˜œíƒ í¬í•¨', price: '4,800 ìºì‹œ' },
        { image: 'âœ¨', title: 'ì´í™íŠ¸ ì•„ì´í…œ', subtitle: 'NEW ì¶œì‹œ', price: '1,200 ìºì‹œ' }
    ]
};

let carouselIndex = { event: 0, cash: 0 };

function changeCarousel(type, direction) {
    const items = carouselData[type + 's'];
    const display = document.getElementById(type + 'Display');
    if (!display || !items) return;
    
    carouselIndex[type] += direction;
    if (carouselIndex[type] < 0) carouselIndex[type] = items.length - 1;
    if (carouselIndex[type] >= items.length) carouselIndex[type] = 0;
    
    // Add transition effect
    display.style.transition = 'opacity 0.3s ease';
    display.style.opacity = '0';
    
    setTimeout(() => {
        const item = items[carouselIndex[type]];
        if (type === 'event') {
            display.innerHTML = `
                <div class="event-icon">${item.icon}</div>
                <div class="event-title-modern">${item.title}</div>
                <div class="event-description">${item.description}</div>
                <div class="event-date-modern">${item.date}</div>
            `;
        } else {
            display.innerHTML = `
                <div class="cash-banner-image">${item.image}</div>
                <div class="cash-banner-title">${item.title}</div>
                <div class="cash-banner-subtitle">${item.subtitle}</div>
                <div class="cash-banner-price">${item.price}</div>
            `;
        }
        display.style.opacity = '1';
    }, 150);
}

function changeEvent(direction) { changeCarousel('event', direction); }
function changeCashItem(direction) { changeCarousel('cash', direction); }

// Auto-rotate carousels
setInterval(() => {
    if (document.getElementById('eventDisplay')) {
        changeEvent(1);
    }
}, 5000);

setInterval(() => {
    if (document.getElementById('cashDisplay')) {
        changeCashItem(1);
    }
}, 6000);


// Make functions globally available
window.changeEvent = changeEvent;
window.changeCashItem = changeCashItem;